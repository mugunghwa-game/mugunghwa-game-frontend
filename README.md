<br>

### 🌺  무궁화 꽃이 피었습니다

---

빠르게 흘러가는 일상 속에서 가끔은 어릴적 친구들과 놀던 추억을 떠올리시나요?

지금 친구들에게 연락해서 함께 놀이하자고 해보세요.

무궁화 꽃이 피었습니다를 통해 지금 이 자리에서 친구들과 함께 그때 그 시절로 돌아갈 수 있습니다.

`#realTime` ` #poseDetection` `#childFriendly `

<br>

### 📦 CONTENTS

---

- 🌺 [무궁화 꽃이 피었습니다](#-무궁화-꽃이-피었습니다)
- 🔍 [Preview](#preview)
- 🖇 [Link](#link)
- 🗓 [Planning](#planning)
- 💫 [Motivation](#motivation)
- 🔮 [Feature](#feature)
- 💻 [Tech Stack](#tech-stack)
- 📋 [Technical Log](#Technical-log)

<br>

### 🔍 Preview

---

https://user-images.githubusercontent.com/83874298/180927088-8a9d4160-57ac-4ada-81cf-444e86dddfe2.mp4

<br>

### 🖇 Link

---

**Deploy**

[무궁화 꽃이 피었습니다](https://mugunghwa.site/)

<br>

### 🗓 Planning

---

**_2022년 6월 27일 ~ 7월 16일 (총 3주)_**

**6월 27일 ~ 7월 3일** : 아이디어 선정 및 기술검증, 칸반 작성 및 목업작업

**7월 4일 ~ 7월 16일 :** 개발 진행, 배포, 테스트 작성

<br>

### 💫  Motivation

---

바쁜 일상을 살다 문득 밤하늘을 올려다보면 어릴적 생각이 많이 나곤 합니다. 친구들과 함께 뛰어다니며 웃고 떠들고 했던 시간들이 그리워집니다.

이제 그 친구들은 모두 이러저러한 사정으로 멀리 살게되었고 시간을 맞춰 만나는 것도 쉽지 않게 되었습니다. 그때의 친구들과 함께 만나지 않아도 함께 놀이를 할 수 있다면 얼마나 좋을까? 하는 생각에서 출발하게 되었습니다.

이제는 아이들의 엄마가 된 친구들과 친구들의 아이들과 함께 할 수 있는 게임을 만들고 싶었고 이 생각이 이번프로젝트의 시작이었습니다.

<br>

### 🔮 Feature

---

- **방 만들기**

사용자는 방을 만들 수 있고, 방을 만들 때 역할을 선택할 수 있습니다.

https://user-images.githubusercontent.com/83874298/180639943-656987ed-fe28-4191-89d2-3590c41b2f09.mov

<br>

- **역할선택**

사용자는 술래와 참가자 중 하나를 선택할 수 있습니다.

https://user-images.githubusercontent.com/83874298/180639942-4013fa9a-669b-4eeb-a146-ac3b3430454a.mov

<br>

- **거리측정**

참가자가 카메라와 일정거리 이상 유지되면 게임모드로 넘어가게 됩니다.

[https://user-images.githubusercontent.com/83874298/180161717-2f7dfd7b-9f97-4a22-82d6-35b2093f771d.mov](https://user-images.githubusercontent.com/83874298/180161717-2f7dfd7b-9f97-4a22-82d6-35b2093f771d.mov)

<br>

- **움직이면 기회수 차감**

술래가 멈춤버튼을 눌렀을 때 참가자가 움직일 경우 기회의 수가 1씩 줄어들게 됩니다.

[https://user-images.githubusercontent.com/83874298/180149564-bee8e192-d5f2-40d4-a620-2b0b41de53ce.mov](https://user-images.githubusercontent.com/83874298/180161195-33b3012a-f2b6-4fff-b2be-36a6a1d29daf.mov)

<br>

- **등때리기 버튼**

참가자가 카메라로부터 일정거리이상 다가오게 되면 ‘등때리기'버튼이 나타나며 이 버튼을 누를 경우 참가자가 승리하게 됩니다.

https://user-images.githubusercontent.com/83874298/180393753-99cd37c8-3326-4275-840e-ba80992d175f.mov

<br>

### 💻 Tech Stack

---

**_Frontend_**

- React
- React-router-dom
- Prop-Types
- Tensorflow.js(pose-detection)
- Socket-io.client
- Simple-peer
- Zustand
- Styled-components

**_Backend_**

- Node.js
- Express
- [Socket.io](http://socket.io/)

**_Test_**

- Jest
- React Testing library
- chai
- socket.io-mock

**_Deploy_**

- Frontend : Netlify
- Backend: AWS Elastic Beanstalk

<br>

### 📋Technical Log

---

### 1️⃣ **움직임 알고리즘**

- **어떤 값으로 움직임을 측정할까?**

tensorflow가 제공해주는 17개의 신체 좌표값을 가지고 어떻게 움직임을 측정할 지에 대한 고민이 많았습니다. 단순히 좌표값이 얼만큼 이상 움직이면 움직였다고 체크할 수도 있겠지만 그것보다 좀 더 논리적인 방법을 찾고자 했습니다. 움직임과 관련된 논문들과 자료들을 찾아보니 대부분의 움직임 유무에 관련된 것들은 cctv와 안전과 관련되어있었으며 동영상을 일정시간 캡쳐하여 그 이미지의 픽셀 차이를 구하여 움직임 유무를 판단하고 있었습니다. tensorflow를 사용하여 동영상을 캡쳐해 움직임의 차이를 알 수도 있었지만 그것보다는 좌표값을 이용해 실시간으로 측정하기를 원했기 때문에 다른 방법을 생각해봤습니다. 그러던 도중 신체의 좌표값을 이용해 절대 각도를 구할 수 있다는 것을 알게되었고 atan2를 사용하게 되었습니다. tensorflow가 제공하는 17개의 신체좌표를 활용하여 왼쪽과 오른쪽의 눈의 각도, 어깨와 팔꿈치 사이의 각도, 양쪽 어깨의 각도, 골반과 무릎의 각도를 구할 수 있었습니다.

게임을 하려면 컴퓨터와 어느정도의 거리가 있어야 했는데 3번의 기회로 어느정도 컴퓨터에 가까이 다가와야 하고 아이들도 함께 할 수 있는 게임으로 기획했기 때문에 너무 가깝지도 멀지도 않은 3m정도로 설정했습니다.

- **하지만 사용자들이 컴퓨터로부터 3m 이상 떨어져 있다는 것을 어떻게 알 수 있을까?**

사용자의 비디오 너비에 대한 사용자의 어깨길이를 체크하면 알 수 있었고 이를 통해 성인과 아동도 구분할 수 있게 되었습니다.

- **성인과 아동은 어떻게 구분할까?**

무궁화 꽃이 피었습니다와 같은 협동놀이는 만 5세부터 가능한데 만 5세의 평균 어깨길이는 24cm, 키는 110cm라는 것을 알게되었고 실제 아동을 구할 수는 없어 저의 키와 어깨길이를 통해 3m 밖에서의 아동의 어깨 비율과 몸통 너비를 알 수 있었습니다. 만약 술래가 난이도를 ‘어려움'을 선택해도 거리 측정 시 아동으로 체크될 경우 ‘쉬움’의 알고리즘이 작동하게 됩니다.

- **어떤게 움직임일까?**

얼만큼 움직여야 움직임으로 볼건지에 대해서는 매번 술래가 ‘멈춤'버튼을 누를때마다 참가자의 어깨 길이를 다시 재며 그에 따라 움직임의 정도를 다르게 체크했습니다. 술래가 멈춤버튼을 누르면 3초 동안 3번의 움직임을 측정하며 움직임 중 처음과 끝을 저장하고 그 값들을 비교했습니다. 움직임이 맞다 아니다를 제가 직접 여러번 테스트해보며 좌표값들을 계산했고 대부분의 사람들이 이건 “움직였다”라고 생각할 정도의 움직임을 체크하는 알고리즘을 만들 수 있었습니다.

- **난이도는 어떤 기준으로 나눠야할까?**

앞서 정한 움직임 기준을 1이라고 하고 난이도를 쉬움으로 정하고 기준의 각도의 범위 기준을 쉬움보다 0.8 정도로 낮춰 어려움으로 나누었습니다.

- **예외 상황은 없을까?**

만약 화면에서 참가자가 사라지거나 몸을 웅크릴 경우에는 어떻게 할지에 대해서도 대응했는데 여러각도로 몸을 웅크려도 신체의 좌표들이 잡혀 tensorflow가 제공하는 신뢰도가 0.7 이상이었고 만약 참가자가 화면에서 안 보이게 될 경우 신뢰도가 0.2이하로 낮아지게 되는 것을 확인했고 알고리즘에 추가하게 되었습니다.

### 2️⃣ **메모리 사용 줄이기**

socket 통신을 하며 simple-peer로 다른사람의 비디오까지 연결 한 상태에서 tensorflow를 실행시키니 비디오가 끊기는 현상이 일어났습니다. 이때 메모리 사용량이 증가되어 이런 현상이 일어나게 된다는것을 인지하게 되었고 pose-detection을 최소한으로 실행시키며 움직임을 측정할 수 있는 정도를 찾아야 했습니다.

여러번의 시도 끝에 제가 선택한 방법은 술래가 멈춤버튼을 누르면 3초동안 pose-detection을 참가자들에게만 적용하고, 연속적으로 실행시키기 보다 1000ms 간격으로 실행시키고, 게임을 진행하는 로직이 있는 컴포넌트들을 분리하여 마운트 되는 시간을 줄이고자 했습니다. 그 결과 메모리 사용량을 33.3%(24mb → 16mb) 줄이고, 컴포넌트 마운트 시간을 68.4%(2.5ms → 0.79ms) 줄일 수 있었습니다.

### 3️⃣ **함수형 프로그래밍 그리고 순수함수**

모션을 인식하는 알고리즘을 순수함수로 작성하고자 노력했습니다. 입력되는 좌표들의 값들을 변경하지않고 단순 계산을 통해 같은 값을 입력할 경우 같은 결과가 나오게끔 유도하고자 했습니다. 처음에 사용할 때는 순수함수에 이점에 대해 느끼지 못했지만 모션인식 알고리즘을 수정할 때 값들을 단순 계산하는 함수로 이루어져있어 어느부분에서 오류가 있는지 추적하기 쉬웠고 수정 또한 어렵지 않았습니다. 순수함수가 아닐 경우 하나의 값을 바꿔주면 나머지 다른 곳에도 영향을 주어 결국에는 거의 모든 코드를 다 확인하고 바꿔줘야 하는 일이 많았지만 순수함수를 사용하니 쉽게 유지보수가 된다는 점을 느낄 수 있었습니다.
